<!DOCTYPE html>
<html>
<body>
<h1>Example</h1>
<script src="polyfill.min.js"></script>
<script src="browser.min.js"></script>
<script src="rx.min.js"></script>
<script src="redux.min.js"></script>
<script src="../dist/rx-web.min.js"></script>
<script type="text/babel">
  const greenTheme = {
    name: 'Green',
    main: 'mediumseagreen',
    secondary: 'tomato'
  };

  const redTheme = {
    name: 'Red',
    main: 'palevioletred',
    secondary: 'slateblue'
  };

  // Reducers
  const themeReducer = (state = {}, action) => {
    switch (action.type) {
      case 'CHANGE_THEME':
        return Object.assign({}, state, { theme: action.theme })
    default:
      return state;
    }
  };

  const reducer = (state = {}, action) => {
  switch (action.type) {
    case 'hl7':
      return {
        ...state,
        data: action.data
      };
    default:
      return state;
  }
};

const reducer1 = (state = {}, action) => {
  switch (action.type) {
    case 'MOCK_FETCHING':
      return {
        ...state,
        data: action.data
      };
    default:
      return state;
  }
};

const reducer2 = (state = {}, action) => {
  switch (action.type) {
    case 'MOCK_FETCH_SUCCESS':
      return {
        ...state,
        data: action.data
      };
    default:
      return state;
  }
};

// Rxweb
const client = new RxWeb.Client();

// Rxweb Middleware/Observers
const filterFunc = task => task.type === 'PARALLEL';
const subscribeFunc = task => { console.log(task.data.counter); };
const parallelMiddleware = new RxWeb.Middleware(filterFunc, subscribeFunc);

client.middlewares = [
  parallelMiddleware,
  new RxWeb.Middleware(
    task => task.type === 'MOCK_FETCH',
    task => {
      console.log('I am subscribing to MOCK_FETCH.');

      async function asideEffect() {
        const { response, data, getState } = task;

        const promise = new Promise(resolve => {
          setTimeout(() => {
            response({
              type: 'MOCK_FETCH_SUCCESS',
              data: {
                ...data,
                other: 1
              }
            });

            console.log(getState());
            resolve();
          }, 3000);
        })

        await promise;
        console.log('I waited for 3 second');

        console.log('Starting some asynchronous tasks...');
        for (let i = 0; i < 100; i++) {
          const t = {
            type: 'PARALLEL',
            data: { counter: i }
          };
          task.next(t);

        }
      }
      asideEffect();
    }
  )
];


client.routes = [
  new RxWeb.Route(
    'hl7',
    (request, response, next, getState) => {
      console.log(`Route is ${request.type}`);
      
      // Update Redux store.
      response({
        type: 'MOCK_FETCHING',
        data: { loading: true }
      });

      // Broadcast to subscribers.
      next({
        type: 'MOCK_FETCH',
        next,
        request,
        response,
        getState,
        data: { counter: 0 }
      });
    }
  )
];

client.start();

// Create store
const middlewares = client.getReduxMiddleware();

const reducers = Redux.combineReducers({ themeReducer, reducer, reducer1, reducer2 })

const store = Redux.createStore(reducers, { theme: greenTheme }, Redux.applyMiddleware(...middlewares));

store.dispatch({type: 'hl7', data: { startTest: true }});

</script>
</body>
</html>