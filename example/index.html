<!DOCTYPE html>
<html>
<body>
<h1>Example</h1>
<script src="polyfill.min.js"></script>
<script src="browser.min.js"></script>
<script src="rx.min.js"></script>
<script src="redux.min.js"></script>
<script src="../dist/rx-web.min.js"></script>
<script type="text/babel">
  const greenTheme = {
    name: 'Green',
    main: 'mediumseagreen',
    secondary: 'tomato'
  };

  const redTheme = {
    name: 'Red',
    main: 'palevioletred',
    secondary: 'slateblue'
  };

  // Reducers
  const themeReducer = (state = {}, action) => {
    switch (action.type) {
      case 'CHANGE_THEME':
        return Object.assign({}, state, { theme: action.theme })
    default:
      return state;
    }
  };

  const reducer = (state = {}, action) => {
  switch (action.type) {
    case 'FOO':
      return {
        ...state,
        data: action.data
      };
    default:
      return state;
  }
};

const reducer1 = (state = {}, action) => {
  switch (action.type) {
    case 'BAR':
      return {
        ...state,
        data: action.data
      };
    default:
      return state;
  }
};

const reducer2 = (state = {}, action) => {
  switch (action.type) {
    case 'REPLY':
      return {
        ...state,
        data: action.data
      };
    default:
      return state;
  }
};

// Rxweb
const client = new RxWeb.Client();

const filterFunc = task => task.type === 'PARALLEL';
const subscribeFunc = task => { console.log(task.data.counter); };
const parallelMiddleware = new RxWeb.Middleware(filterFunc, subscribeFunc);

client.middlewares = [
  parallelMiddleware,
  new RxWeb.Middleware(
    task => task.type === 'FOO',
    task => {
      console.log('I only react to foo.');

      async function asideEffect() {
        const promise = new Promise(resolve => {
          setTimeout(() => {
            task.dispatch({type: task.type, data: Object.assign({silly:1}, task.data)});            
            console.log(task.getState());
            resolve();
          }, 3000);
        })

        await promise;
        console.log('I waited for 3 second');

        console.log('Starting some asynchronous tasks...');
        for (let i = 0; i < 100; i++) {
          const t = new RxWeb.Task('PARALLEL', { counter: i });
          task.next(t);
        }
      }
      asideEffect();
    }
  )
];
client.routes = [
  new RxWeb.Route(
    'hl7',
    (next, dispatch, action, getState) => {
      console.log(`Route is ${action.type}`);
      const t = new RxWeb.Task('FOO', { counter: 0 }, next, dispatch, action, getState);

      next(t);
    }
  )
];

client.start();

// Create store
const middlewares = client.getReduxMiddleware();

const reducers = Redux.combineReducers({ themeReducer, reducer, reducer1, reducer2 })

const store = Redux.createStore(reducers, { theme: greenTheme }, Redux.applyMiddleware(...middlewares));

store.dispatch({type: 'hl7'});

</script>
</body>
</html>